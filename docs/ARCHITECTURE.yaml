id: architecture
title: Cobbler Architecture

overview:
  summary: |
    Cobbler cobbles together context for AI coding agents. We use the crumbs
    cupboard to store all work: both cobbler's own (planning, evaluation, design
    proposals) and work intended for agents (documentation, code). A property on
    each crumb indicates its type: planning, documentation, coding, or operations.
    Cobbler reads tasks from the cupboard, assembles context from project files
    and templates, dispatches each task to an agent one-shot, evaluates the
    result, updates task state, and creates new work as it discovers it. Over
    repeated cycles, cobbler iteratively manages what agents see and do. The
    agent does not iterate; it receives everything it needs upfront and returns
    a result.

    Cobbler replaces prototype bash scripts (make-work.sh and do-work.sh) with
    a structured Go CLI. Where the scripts built prompts through string
    concatenation and shelled out to bd commands, cobbler uses Go templates for
    prompt construction and calls cupboard methods directly via the imported
    crumbs module.
  lifecycle: |
    A work item flows through cobbler in stages: ready (item exists in cupboard,
    eligible for pickup), taken (cobbler claims item via Table.Set, begins
    prompt construction), executing (agent receives prompt, produces output),
    quality gate (cobbler runs validation), and closed (cobbler updates state,
    records outcome as completed or failed). The crumbs Crumb entity has states:
    draft, pending, ready, taken, completed, failed, archived. Cobbler operates
    on crumbs in the ready state and transitions them through taken to completed
    or failed.
  coordination_pattern: |
    Cobbler uses a pull model. The CLI queries the cupboard for crumbs in the
    ready state, picks one, claims it by setting state to taken, and proceeds
    with execution. No push notifications or pub/sub announcements exist;
    cobbler drives all state transitions. This pattern matches the crumbs
    design: crumbs provides storage, not operation.

interfaces:
  - name: Cupboard Integration
    summary: |
      We import github.com/petar-djukic/crumbs and use the Cupboard and Table
      interfaces directly. Callers use the pattern
      Cupboard.GetTable("crumbs").Get(id).
    data_structures:
      - "Cupboard (attach, detach, GetTable)"
      - "Table (Get, Set, Delete, Fetch)"
      - "Config (Backend, DataDir)"
    operations:
      - "Get(id) — retrieve entity by ID"
      - "Set(id, data) — create or update entity"
      - "Delete(id) — remove entity"
      - "Fetch(filter) — query with field filter"
  - name: Agent Interface
    summary: |
      The Agent interface abstracts LLM providers. We start with Claude via
      anthropic-sdk-go; the interface enables future providers without changing
      dispatch code.
    data_structures:
      - "Request (Messages, Tools, Config)"
      - "Response (Content, ToolCalls, Usage, StopReason)"
      - "Message (Role, Content, ToolCallID)"
    operations:
      - "Agent.Run(ctx, req) — send prompt to LLM and return response"
  - name: Tool Interface
    summary: |
      Tools are functions the agent can invoke during execution. Each tool
      declares its name, description, and parameter schema.
    operations:
      - "Name() — tool identifier"
      - "Description() — human-readable description"
      - "Parameters() — JSON Schema for arguments"
      - "Execute(ctx, args) — run tool with arguments"
  - name: Executor Interface
    summary: |
      The Executor manages the claim-execute-close workflow for a single task.
    operations:
      - "Execute(ctx, crumb) — claim, build prompt, run agent, validate, update state"
  - name: Prompt Builder
    summary: |
      The Prompt Builder constructs prompts from templates and task context.
      Templates live in internal/prompt as Go templates or embedded strings.

components:
  - name: CLI (cmd/cobbler)
    responsibility: |
      Entry point using cobra for command parsing. Registers subcommands
      (measure, stitch, inspect, mend, pattern) with cobra. Initializes
      config via viper.
    capabilities:
      - Command parsing and help generation
      - Configuration initialization
  - name: Config (internal/config)
    responsibility: |
      Loads and validates configuration. Cupboard settings, agent settings,
      and execution settings.
    capabilities:
      - Load from file and environment
      - Validate required fields
  - name: Measure (internal/measure)
    responsibility: |
      Reads VISION, ARCHITECTURE, ROADMAP, and cupboard state. Invokes an
      agent to analyze project state and propose new crumbs. Replaces
      make-work.sh.
    capabilities:
      - Project state reading
      - Context assembly for planning agent
      - Proposal output and cupboard write-back
  - name: Stitch (internal/stitch)
    responsibility: |
      Picks a ready crumb, claims it, builds a prompt, runs the agent,
      validates output, and closes the crumb. Replaces do-work.sh.
    capabilities:
      - Task picking and claiming
      - Work-type-specific context assembly
      - Git worktree management for code tasks
      - Quality gate execution
  - name: Inspect (internal/inspect)
    responsibility: |
      Evaluates recent work for quality issues. Runs an agent with inspection
      prompts. Reports findings without making changes.
    capabilities:
      - Quality evaluation
      - Finding reporting
  - name: Mend (internal/mend)
    responsibility: |
      Fixes issues identified by inspect. Claims a crumb with findings,
      invokes an agent to make corrections, validates the fix.
    capabilities:
      - Issue fixing
      - Fix validation
  - name: Pattern (internal/pattern)
    responsibility: |
      Proposes architectural changes. Analyzes project structure, identifies
      technical debt or design improvements, outputs proposals as new crumbs
      or documentation updates.
    capabilities:
      - Structural analysis
      - Design proposal generation
  - name: Agent (internal/claude)
    responsibility: |
      Claude implementation of the Agent interface using anthropic-sdk-go.
      Manages API calls, streaming responses, and tool execution.
    capabilities:
      - API call management
      - Streaming responses
      - Rate limiting and retries
  - name: Crumbs Client (internal/crumbs)
    responsibility: |
      Thin wrapper around the imported crumbs module. Provides convenience
      methods for common operations.
    capabilities:
      - Fetch ready crumbs
      - Claim and close crumbs
      - Add metadata

design_decisions:
  - id: 1
    title: Import crumbs as Go module
    decision: |
      We import github.com/petar-djukic/crumbs and call cupboard methods
      directly rather than wrapping bd CLI commands.
    benefits:
      - Type safety
      - No process spawning overhead
      - Direct access to entity structs
    alternatives_rejected:
      - Wrapping bd CLI commands loses type information and adds shell parsing complexity
  - id: 2
    title: Agent interface for provider abstraction
    decision: |
      The Agent interface decouples dispatch from LLM provider. We implement
      Claude first via anthropic-sdk-go.
    benefits:
      - Add providers without changing executor code
      - Test with mock agents
    alternatives_rejected:
      - Hardcoding Claude calls spreads provider-specific logic throughout the codebase
  - id: 3
    title: Prompt templates in internal/prompt
    decision: |
      Templates are Go templates or embedded strings in the internal/prompt
      package.
    benefits:
      - Templates are testable Go code
      - IDE support for editing
      - Compile-time errors for missing variables
    alternatives_rejected:
      - External template files add deployment complexity and make testing harder
  - id: 4
    title: Commands named after shoemaking terms
    decision: |
      Cobbler commands (measure, stitch, inspect, mend, pattern) follow the
      shoemaking metaphor. The five commands cover a full cycle: assess,
      execute, evaluate, fix, redesign.
    benefits:
      - Memorable naming
      - Consistent theme with project name
    alternatives_rejected:
      - Generic names (plan, run, check, fix, design) lack distinctiveness
  - id: 5
    title: Git worktree isolation for code tasks
    decision: |
      Code tasks execute in a worktree on a task-specific branch. Main branch
      stays clean during execution.
    benefits:
      - Main branch stays clean during execution
      - Multiple tasks can run in parallel in future
      - Failed tasks leave main unaffected
    alternatives_rejected:
      - Working directly on main risks leaving partial changes on failure
  - id: 6
    title: Quality gates before closing
    decision: |
      The executor runs validation (tests, linter, build) before marking a
      crumb completed.
    benefits:
      - Catch failures before closing
      - Enable mend to fix issues
    alternatives_rejected:
      - Closing immediately after agent output loses the feedback loop

technology_choices:
  - component: Language
    technology: Go
    purpose: CLI tool; strong typing, concurrency, single binary
  - component: CLI framework
    technology: cobra
    purpose: Command parsing, help generation, subcommands
  - component: Configuration
    technology: viper
    purpose: File and environment config, YAML/JSON support
  - component: Cupboard
    technology: github.com/petar-djukic/crumbs
    purpose: Work item storage; imported as Go module
  - component: LLM client
    technology: anthropic-sdk-go
    purpose: Claude API; streaming, tool use
  - component: Testing
    technology: Go testing + testify
    purpose: Unit and integration tests

project_structure:
  - path: cmd/cobbler/
    role: CLI entry point, cobra root command
  - path: pkg/agent/
    role: Agent and Tool interfaces (public API)
  - path: pkg/executor/
    role: Executor interface (public API)
  - path: internal/config/
    role: Configuration loading and validation
  - path: internal/claude/
    role: Claude Agent implementation
  - path: internal/prompt/
    role: Prompt templates and builder
  - path: internal/measure/
    role: Measure command logic
  - path: internal/stitch/
    role: Stitch command logic (executor impl)
  - path: internal/inspect/
    role: Inspect command logic
  - path: internal/mend/
    role: Mend command logic
  - path: internal/pattern/
    role: Pattern command logic
  - path: internal/crumbs/
    role: Crumbs cupboard convenience wrapper
  - path: docs/
    role: Project documentation (VISION, ARCHITECTURE, specs)
  - path: .claude/
    role: Project rules for AI agents

implementation_status:
  current_focus: |
    Phase 01.0: stitch for documentation. The focus is cobbler stitch
    executing documentation tasks with cupboard read/write via the crumbs
    module and prompt templates for doc work.
  progress:
    - "01.0": Current
    - "02.0": Planned
    - "03.0": Planned
    - "04.0": Planned

related_documents:
  - doc: VISION.yaml
    purpose: Goals, boundaries, phases, success criteria
  - doc: prd-cupboard-core.md (crumbs)
    purpose: Cupboard interface, Table interface, lifecycle
  - doc: prd-crumbs-interface.md (crumbs)
    purpose: Crumb entity, state transitions, properties
  - doc: prd-trails-interface.md (crumbs)
    purpose: Trail entity, exploration sessions
